"use strict";WPForms.Admin.Builder.Providers.Tribe=WPForms.Admin.Builder.Providers.Tribe||function(o,e,c){var a={$holder:null,config:{templates:["wpforms-tribe-builder-content-connection","wpforms-tribe-builder-content-connection-required-fields","wpforms-tribe-builder-content-connection-error","wpforms-tribe-builder-content-connection-conditionals"]},replaceConnectionIds:function(o,e){e.find("input, textarea, select, label").each(function(){var e=c(this);e.attr("name")&&e.attr("name",e.attr("name").replace(/%connection_id%/gi,o)),e.attr("id")&&e.attr("id",e.attr("id").replace(/%connection_id%/gi,o)),e.attr("for")&&e.attr("for",e.attr("for").replace(/%connection_id%/gi,o)),e.attr("data-name")&&e.attr("data-name",e.attr("data-name").replace(/%connection_id%/gi,o))})},connectionAccountExists:function(e,o){return!_.isEmpty(o)&&(!!_.isEmpty(e)||_.has(o,e))}},s={provider:"tribe",Providers:{},Templates:{},Cache:{},isReady:!1,init:function(){c(function(){_.isObject(e.wpformsTribeBuilderVars)&&_.has(e.wpformsTribeBuilderVars,"authNotice")&&s.modal(wpformsTribeBuilderVars.authNotice)}),"providers"===wpf.getQueryString("view")&&c("#wpforms-panel-providers").on("WPForms.Admin.Builder.Providers.ready",s.ready),c(o).on("wpformsPanelSwitched",function(e,o){"providers"===o&&s.ready()})},ready:function(){s.isReady||(s.Providers=WPForms.Admin.Builder.Providers,s.Templates=WPForms.Admin.Builder.Templates,s.Cache=s.Providers.cache,a.$holder=s.Providers.getProviderHolder(s.provider).find(".wpforms-builder-provider-connections"),s.Templates.add(a.config.templates),s.Providers.ui.account.registerAddHandler(s.provider,s.processAccountAdd),s.bindUIActions(),s.bindTriggers(),s.processInitial(),s.isReady=!0)},bindUIActions:function(){s.Providers.getProviderHolder(s.provider).on("connectionCreate",s.connection.callbacks.create).on("connectionDelete",s.connection.callbacks.delete).on("change",".js-wpforms-builder-tribe-provider-connection-account",s.ui.account.changeCallback).on("change",".js-wpforms-builder-tribe-provider-connection-object",s.ui.object.changeCallback),c(o).on("click",".wpforms-tribe-setting-field-redirect-copy",s.ui.copyUrlClick)},bindTriggers:function(){a.$holder.on("connectionsDataLoaded",function(e,o){if(!_.isEmpty(o.connections))for(var n in o.connections)s.connection.callbacks.generate({connection:o.connections[n],conditional:o.conditionals[n]})}),a.$holder.on("connectionGenerated",function(e,o){var n=s.connection.getById(o.connection.id);_.has(o.connection,"isNew")&&o.connection.isNew?a.replaceConnectionIds(o.connection.id,n):c(".js-wpforms-builder-tribe-provider-connection-object",n).trigger("change",[n])})},processInitial:function(){a.$holder.prepend(s.tmpl.callbacks.commonsHTML()),s.connection.callbacks.dataLoad()},processAccountAdd:function(e){var o=e.$content.find("form"),n=e.$content.find(".error"),r=o.find('input[name="client_id"]'),t=o.find('input[name="client_secret"]'),i=r.val().trim(),c=t.val().trim();return _.isEmpty(i)||_.isEmpty(c)?(n.show(),e.setType("red"),r.addClass("wpforms-error"),t.addClass("wpforms-error")):(n.hide(),e.setType("blue"),r.removeClass("wpforms-error"),t.removeClass("wpforms-error"),s.Providers.ajax.request(s.provider,{data:{task:"account_save",data:{client_id:i,client_secret:c}}}).done(function(e){e.success?(o.find('input[name="state"]').val(wpf.sanitizeHTML(e.data.state)),wpf.savedState=wpf.getFormState("#wpforms-builder-form"),o.submit()):(_.has(e,"data")&&_.has(e.data,"error_msg")&&n.html(e.data.error_msg),n.show())})),!1},connection:{getById:function(e){return a.$holder.find('.wpforms-builder-provider-connection[data-connection_id="'+e+'"]')},callbacks:{create:function(e,o){var n=(new Date).getTime().toString(16),o={id:n,name:o,isNew:!0};s.Cache.addTo(s.provider,"connections",n,o),s.connection.callbacks.generate({connection:o})},delete:function(e,o){var n=s.Providers.getProviderHolder(s.provider);o.closest(n).length&&(n=o.data("connection_id"),_.isString(n))&&s.Cache.deleteFrom(s.provider,"connections",n)},generate(r){const e=s.Templates.get(`wpforms-${s.provider}-builder-content-connection`);var o=c(`#tmpl-wpforms-${s.provider}-builder-content-connection-conditionals`).length?s.Templates.get(`wpforms-${s.provider}-builder-content-connection-conditionals`):s.Templates.get("wpforms-providers-builder-content-connection-conditionals");const n=_.has(r.connection,"isNew")&&r.connection.isNew?o():r.conditional,t=s.Cache.get(s.provider,"accounts");function i(){a.$holder.prepend(e({objects:s.Cache.get(s.provider,"objects"),accounts:t,connection:r.connection,conditional:n,provider:s.provider})),a.$holder.trigger("connectionGenerated",[r])}_.isEmpty(t)?s.Providers.ajax.request(s.provider,{data:{task:"accounts_get"}}).done(function(e){if(e.success&&_.has(e.data,"accounts"))s.Cache.set(s.provider,"accounts",e.data.accounts),a.connectionAccountExists(r.connection.account_id,e.data.accounts)&&i();else if(_.has(e.data,"error_msg")){var o=a.$holder.find(".wpforms-builder-provider-connections-error");for(const n of e.data.error_msg)o.append(n);o.show()}}):a.connectionAccountExists(r.connection.account_id,t)&&i()},dataLoad:function(){s.Providers.ajax.request(s.provider,{data:{task:"connections_get"}}).done(function(e){e.success&&_.has(e.data,"connections")&&(s.Cache.set(s.provider,"connections",jQuery.extend({},e.data.connections)),s.Cache.set(s.provider,"conditionals",jQuery.extend({},e.data.conditionals)),s.Cache.set(s.provider,"objects",jQuery.extend({},e.data.objects)),_.isEmpty(e.data.accounts)||s.Cache.set(s.provider,"accounts",jQuery.extend({},e.data.accounts)),a.$holder.trigger("connectionsDataLoaded",[e.data]))})}}},ui:{account:{changeCallback:function(){var e=c(this),o=e.closest(".wpforms-builder-provider-connection"),n=c(".js-wpforms-builder-tribe-provider-connection-object",o);c(".wpforms-builder-tribe-provider-actions-data",o).empty(),n.prop("selectedIndex",0),_.isEmpty(e.val())?n.prop("disabled",!0):(n.prop("disabled",!1),e.removeClass("wpforms-error"))}},object:{changeCallback:function(){var e=c(this),o=e.closest(".wpforms-builder-provider-connection"),n=c(".js-wpforms-builder-tribe-provider-connection-account",o);c(".wpforms-builder-tribe-provider-actions-data",o).empty(),e.removeClass("wpforms-error"),s.actions.init({action:"object_create",target:e,option_id:n.find("option:selected").data("option_id"),account_id:n.val(),connection_id:o.data("connection_id")})}},copyUrlClick:function(){var e=c(this);c("#"+e.data("source_id")).get(0).select(),o.execCommand("Copy"),e.removeClass("animate"),this.offsetWidth,e.addClass("animate")}},actions:{init:function(e){"object_create"===e.action&&s.actions.object.create.init(e)},object:{create:{init:function(e){var o;_.isEmpty(e.account_id)||_.isEmpty(e.target.val())||(o=s.Cache.get(s.provider,"customFields"),_.isObject(o)&&!_.isEmpty(o)&&_.has(o,e.account_id)&&_.has(o[e.account_id],e.target.val())?this.render(e):this.request(e))},request(r){const t=this,i=a.$holder.find(".wpforms-builder-provider-connections-error"),c=r.target.val();s.Providers.ajax.request(s.provider,{data:{task:"object_data_get",object_name:c,option_id:r.option_id}}).done(function(e){var o,n;!e.success||_.isEmpty(e.data)?(_.isEmpty(e.data.error_msg)||i.html(e.data.error_msg),a.$holder.find(".wpforms-builder-provider-connections-error").show()):(o=s.Cache.get(s.provider,"customFields"),n={},_.isUndefined(o)&&s.Cache.set(s.provider,"customFields",o={}),_.has(o,r.account_id)||(o[r.account_id]={},s.Cache.set(s.provider,"customFields",o)),(n=o[r.account_id])[c]=e.data,s.Cache.addTo(s.provider,"customFields",r.account_id,n),t.render(r))})},render:function(e){var o=wpf.getFields(),n=s.tmpl.callbacks.optionalFieldsHTML(e,o),o=s.tmpl.callbacks.requiredFieldsHTML(e,o),r=s.connection.getById(e.connection_id);r.find(".wpforms-builder-tribe-provider-actions-data").html(n),_.isEmpty(o)||r.find(".wpforms-builder-provider-connection-fields-table tbody").prepend(o),a.$holder.trigger("connectionRendered",[s.provider,e.connection_id])}}}},tmpl:{callbacks:{commonsHTML(){return s.Templates.get("wpforms-"+s.provider+"-builder-content-connection-error")()},optionalFieldsHTML(e,o){var n=e.target.val(),r=s.Templates.get("wpforms-providers-builder-content-connection-fields"),t=s.Cache.getById(s.provider,"customFields",e.account_id),e=s.Cache.getById(s.provider,"connections",e.connection_id);let i;return e.object!==n?((i=_.clone(e)).fields_meta=[],i.fields_required=[]):i=e,r({connection:i,fields:o,provider:{placeholder:wpformsTribeBuilderVars.l10n.provider_placeholder,slug:s.provider,fields:t[n].optional}})},requiredFieldsHTML:function(e,o){var n=s.Templates.get("wpforms-"+s.provider+"-builder-content-connection-required-fields"),r=s.Cache.getById(s.provider,"customFields",e.account_id);return _.has(r[e.target.val()],"required")?n({connection:s.Cache.getById(s.provider,"connections",e.connection_id),fields:o,provider:{slug:s.provider,fields:r[e.target.val()].required}}):""}}},modal:function(e){var o=wpforms_builder.heads_up,n="fa fa-exclamation-circle",r="orange";_.has(e,"type")&&_.has(e,"message")&&("success"===e.type&&(o=wpforms_builder.saved,n="fa fa-check-circle",r="green"),c.alert({title:o,content:e.message,icon:n,type:r,buttons:{confirm:{text:wpforms_builder.ok,btnClass:"btn-confirm",keys:["enter"]}}}))}};return s}(document,window,jQuery),WPForms.Admin.Builder.Providers.Tribe.init();